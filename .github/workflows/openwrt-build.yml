name: OpenWRT Build for newifi-d2 (Stable)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-23.05
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/*
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl libelf-dev bc binutils
        sudo apt autoremove -y && sudo apt clean -y
        sudo timedatectl set-timezone "$TZ"
        ulimit -n 65535

    - name: Clone source code
      run: |
        git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        # 移除 telephony 源，只更新核心源
        ./scripts/feeds update core packages luci routing

    - name: Add stable third-party feeds (修正分支为master+容错)
      run: |
        cd openwrt
        # 修正分支为master（kenzok8仓库的默认分支是master而非main）
        echo "src-git small https://github.com/kenzok8/small.git;master" >> feeds.conf.default
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages.git;master" >> feeds.conf.default
        # 增加容错：即使源更新失败也继续，避免终止编译
        ./scripts/feeds update small kenzo || true
        # 优先安装核心插件，避免全量安装触发无效目录检测
        ./scripts/feeds install -y luci-app-ssr-plus luci-theme-argon
        ./scripts/feeds install -a || true

    - name: Configure firmware (极简配置，仅保留核心)
      run: |
        cd openwrt
        # 加载newifi-d2默认配置
        cp target/linux/ramips/mt7621/config-5.15 target/linux/ramips/mt7621/config-6.1
        make defconfig
        # 配置newifi-d2为目标设备
        echo "CONFIG_TARGET_ramips=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
        echo "CONFIG_TARGET_ramips_mt7621_DEVICE_newifi-d2=y" >> .config
        # 仅保留核心功能
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-opkg=y" >> .config
        echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
        # 仅保留SSR Plus+基础版（移除PassWall2减少冲突）
        echo "CONFIG_PACKAGE_luci-app-ssr-plus=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Base=y" >> .config
        # 禁用所有可能冲突的选项
        echo "CONFIG_PACKAGE_webd=n" >> .config
        echo "CONFIG_PACKAGE_webdav2=n" >> .config
        echo "CONFIG_KERNEL_MTD_SPLIT_OPENWRT_PROLOG=n" >> .config
        # 清理无效配置
        make defconfig

    - name: Fix compile issues (终极修复)
      run: |
        cd openwrt
        # 禁用fallocate，改用truncate
        sed -i 's/fallocate -l/fallocate -l || truncate -s/g' include/image-commands.mk
        # 禁用所有编译警告转为错误
        sed -i 's/CFLAGS += -Wall/CFLAGS += -Wall -Wno-error/g' include/target.mk
        sed -i 's/CXXFLAGS += -Wall/CXXFLAGS += -Wall -Wno-error/g' include/target.mk
        # 增加内存交换空间（解决云编译内存不足）
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile

    - name: Download packages
      run: |
        cd openwrt
        make download -j1

    - name: Compile firmware (单线程+最大容错)
      run: |
        cd openwrt
        make -j1 V=s || make -j1 V=s  # 失败后重试一次

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: newifi-d2-openwrt-firmware
        path: openwrt/bin/targets/ramips/mt7621/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: newifi-d2-openwrt-firmware
        path: openwrt/bin/targets/ramips/mt7621/
